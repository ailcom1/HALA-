
<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>عداد النقاط</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .points-box {
            border: 2px solid orange;
            border-radius: 10px;
            padding: 5px 20px;
            font-size: 18px;
            font-weight: bold;
            background-color: white;
            color: black;
            text-align: center;
            margin-bottom: 40px;
            position: absolute;
            top: 20px;
        }

        .circle {
            width: 220px;
            height: 220px;
            background-color: black;
            border-radius: 50%;
            border: 10px solid orange;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .countdown-button {
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            margin-bottom: 20px; /* لإضافة مساحة قبل الشريط الإخباري */
        }

        .countdown-button:hover {
            background: linear-gradient(45deg, #0072ff, #00c6ff);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
        }

        .profile-button {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid orange;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-button img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* الشريط الإخباري */
        .news-ticker {
            width: 100vw;
            background-color: orange;
            color: white;
            font-size: 18px;
            font-weight: bold;
            padding: 10px 0;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
        }

        .news-ticker span {
            display: inline-block;
            padding-left: 100%;
            animation: ticker 10s linear infinite;
        }

        @keyframes ticker {
            0% {
                transform: translateX(100%);
            }
            100% {
                transform: translateX(-100%);
            }
        }

    </style>
</head>
<body>

<button class="profile-button" id="profileButton">
    <img src="https://www.w3schools.com/w3images/avatar2.png" alt="Profile">
</button>

<div class="points-box">
    نقاط متحصلة: <span id="points">0</span>
</div>

<div class="circle" id="rainContainer"></div>

<button class="countdown-button" id="countdownButton">تشغيل</button>

<!-- الشريط الإخباري المتحرك -->
<div class="news-ticker">
    <span>انتباه يمكن سحب نقاطك من داخل تطبيق يوم الخميس فقط عن طريق تواصل عبر تلكرام@sadhdu </span>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBfGV0d4rXbwEUTtk5CRVIWMWTkixwt7_0",
        authDomain: "this-is-a-referral.firebaseapp.com",
        databaseURL: "https://this-is-a-referral-default-rtdb.firebaseio.com",
        projectId: "this-is-a-referral",
        storageBucket: "this-is-a-referral.appspot.com",
        messagingSenderId: "755422423785",
        appId: "1:755422423785:web:5e85a37d5d4e68ed1d9e78",
        measurementId: "G-4LR763ZZHE"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    
    // تأكد من الحصول على اسم المستخدم
    const username = localStorage.getItem('username');
    if (!username) {
        console.error('No username found in localStorage!');
        alert('لم يتم العثور على اسم المستخدم. الرجاء التحقق من أنه مخزن في localStorage.');
    } else {
        console.log('Username from localStorage:', username);
    }

    const pointsBox = document.getElementById('points');

    let points = 0;
    let timeLeft = 86400; // 24 ساعة
    let startTime = null;
    let countdownActive = false;

    const countdownButton = document.getElementById('countdownButton');
    const rainContainer = document.getElementById('rainContainer');

    // تحقق من وجود بيانات المستخدم في Firebase
    const userRef = ref(database, `users/${username}`);
    console.log('Database reference path:', userRef);

    // جلب البيانات عند تحميل الصفحة
    get(userRef).then((snapshot) => {
        if (snapshot.exists()) {
            const data = snapshot.val();
            console.log('Fetched data:', data);

            points = data.points || 0;
            startTime = data.startTime || null;

            // عرض النقاط المجمعة
            pointsBox.textContent = points;

            if (startTime) {
                const currentTime = Math.floor(Date.now() / 1000);
                const elapsedTime = currentTime - startTime;
                timeLeft = Math.max(86400 - elapsedTime, 0);

                updateCountdownDisplay(timeLeft);
                if (timeLeft > 0) {
                    countdownButton.disabled = true; // تعطيل الزر إذا كان العد مستمر
                    countdownActive = true;
                    startCountdown(); // استئناف العد التنازلي
                } else {
                    countdownButton.disabled = false;
                }
            } else {
                pointsBox.textContent = points;  // عرض النقاط في الصندوق
            }
        } else {
            console.log("No data available for this user.");
        }
    }).catch((error) => {
        console.error("Error fetching data:", error.message);
        alert('حدث خطأ أثناء جلب البيانات من قاعدة البيانات.');
    });

    countdownButton.addEventListener('click', function() {
        if (countdownActive) return;  // منع إعادة البدء إذا كان العد مستمر
        countdownButton.disabled = true;
        countdownActive = true;
        startTime = Math.floor(Date.now() / 1000);
        set(ref(database, `users/${username}/startTime`), startTime);

        startCountdown();
    });

    function startCountdown() {
        const countdownInterval = setInterval(function() {
            const currentTime = Math.floor(Date.now() / 1000);
            timeLeft = Math.max(86400 - (currentTime - startTime), 0);

            updateCountdownDisplay(timeLeft);

            if (timeLeft <= 0) {
                clearInterval(countdownInterval);
                countdownButton.textContent = "انتهى الوقت!";
                countdownButton.disabled = false;
                countdownActive = false;

                points += 100;
                pointsBox.textContent = points;

                set(ref(database, `users/${username}/points`), points)
                    .then(() => {
                        console.log("Points saved successfully.");
                    })
                    .catch((error) => {
                        console.error("Error saving points:", error);
                    });

                set(ref(database, `users/${username}/startTime`), null);
            }
        }, 1000);
    }

    function updateCountdownDisplay(seconds) {
        const hours = Math.floor(seconds / 3600).toString().padStart(2, '0');
        const minutes = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
        const remainingSeconds = (seconds % 60).toString().padStart(2, '0');
        countdownButton.textContent = `${hours}:${minutes}:${remainingSeconds}`;
    }

    // الانتقال إلى صفحة البروفايل عند الضغط على زر البروفايل
    document.getElementById('profileButton').addEventListener('click', function() {
        window.location.href = 'user.html'; // الانتقال إلى صفحة البروفايل
    });

</script>

</body>
</html>
